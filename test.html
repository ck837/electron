<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Serial Communication Debug</title>
</head>
<body>
<button onclick="sendMsg()">发送</button>
<button onclick="serial()">启动串口调试</button>
<script type="text/javascript">
    let writer = null, getData = [], timeOut;
    async function sendMsg() {  
        const data = new Uint8Array(toUint8Arr('test1234'));
        await writer.write(data);
    }
    async function serial() {
        if ('serial' in navigator) {
            console.log('当前浏览器支持serial');
            const port = await navigator.serial.requestPort();
            await port.open({ baudRate: 115200 });
            const reader = port.readable.getReader();
            writer = port.writable.getWriter();
            try {
                while (true) {
                    const { value, done } = await reader.read();
                    if (done) {
                        reader.releaseLock();
                        break;
                    }
                    let arr = Array.from(value);
                    getData.push(...arr);
                    if (timeOut) clearTimeout(timeOut);
                    timeOut = setTimeout(() => {
                        console.log(Uint8ArrayToString(new Uint8Array(getData)));
                        getData = [];
                        timeOut = null;
                    }, 200);
                }
            } catch (error) {
                console.error(error);
            } finally {
                reader.releaseLock();
                console.log('允许稍后关闭串口。');
                await port.close();
            }
        } else {
            console.log('当前浏览器不支持serial');
        }
    }
    function toUint8Arr(str) {
        const buffer = [];
        for (let i of str) {
            const _code = i.charCodeAt(0);
            if (_code < 0x80) {
                buffer.push(_code);
            } else if (_code < 0x800) {
                buffer.push(0xc0 + (_code >> 6));
                buffer.push(0x80 + (_code & 0x3f));
            } else if (_code < 0x10000) {
                buffer.push(0xe0 + (_code >> 12));
                buffer.push(0x80 + (_code >> 6 & 0x3f));
                buffer.push(0x80 + (_code & 0x3f));
            }
        }
        return Uint8Array.from(buffer);
    }
    function Uint8ArrayToString(serialData) {
        var out, i, len, c;
        var char2, char3;
        out = "";
        len = serialData.length;
        i = 0;
        while (i < len) {
            c = serialData[i++];
            switch (c >> 4) {
                case 0: case 1: case 2: case 3: case 4: case 5: case 6: case 7:
                    out += String.fromCharCode(c);
                    break;
                case 12: case 13:
                    char2 = serialData[i++];
                    out += String.fromCharCode(((c & 0x1F) << 6) | (char2 & 0x3F));
                    break;
                case 14:
                    char2 = serialData[i++];
                    char3 = serialData[i++];
                    out += String.fromCharCode(((c & 0x0F) << 12) |
                        ((char2 & 0x3F) << 6) |
                        ((char3 & 0x3F) << 0));
                    break;
            }
        }
        return out;
    }
</script>
</body>
</html>
